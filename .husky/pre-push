#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

# ÐŸÐ¾Ð»ÑƒÑ‡Ð°ÐµÐ¼ Ñ‚ÐµÐºÑƒÑ‰ÑƒÑŽ Ð²ÐµÑ‚ÐºÑƒ
CURRENT_BRANCH=$(git rev-parse --abbrev-ref HEAD 2>/dev/null)

# ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼, Ð½Ð°Ñ‡Ð¸Ð½Ð°ÐµÑ‚ÑÑ Ð»Ð¸ Ð²ÐµÑ‚ÐºÐ° Ñ "feature/"
if [ -z "$CURRENT_BRANCH" ] || ! echo "$CURRENT_BRANCH" | grep -q '^feature/'; then
  echo "â„¹ï¸ Ð’ÐµÑ‚ÐºÐ° $CURRENT_BRANCH Ð½Ðµ ÑÐ¾Ð¾Ñ‚Ð²ÐµÑ‚ÑÑ‚Ð²ÑƒÐµÑ‚ pattern 'feature/*' â€” changeset Ð½Ðµ Ð¾Ð±Ñ€Ð°Ð±Ð°Ñ‚Ñ‹Ð²Ð°ÐµÑ‚ÑÑ"
  exit 0
fi

# ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼, ÐµÑÑ‚ÑŒ Ð»Ð¸ Ñ„Ð»Ð°Ð³ --no-verify
if [ "$HUSKY_GIT_PARAMS" = "--no-verify" ]; then
  echo "âœ… Ð¥ÑƒÐº Ð¿Ñ€Ð¾Ð¿ÑƒÑ‰ÐµÐ½ (Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ð½ --no-verify)"
  exit 0
fi

# ÐŸÐ¾Ð»ÑƒÑ‡Ð°ÐµÐ¼ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ðµ Ð¿Ð¾ÑÐ»ÐµÐ´Ð½ÐµÐ³Ð¾ ÐºÐ¾Ð¼Ð¼Ð¸Ñ‚Ð°
COMMIT_MSG=$(git log -1 --pretty=%B)
echo "ðŸ“Ž Ð¡Ð¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ðµ Ð¿Ð¾ÑÐ»ÐµÐ´Ð½ÐµÐ³Ð¾ ÐºÐ¾Ð¼Ð¼Ð¸Ñ‚Ð°: $COMMIT_MSG"

# ÐŸÐ°Ñ€ÑÐ¸Ð¼ Ñ‚Ð¸Ð¿ Ð¸ Ð¾Ð¿Ð¸ÑÐ°Ð½Ð¸Ðµ
COMMIT_TYPE="${COMMIT_MSG%%:*}"
COMMIT_TYPE=$(echo "$COMMIT_TYPE" | tr '[:upper:]' '[:lower:]')
COMMIT_DESCRIPTION=$(echo "$COMMIT_MSG" | sed -E 's/^[^:]+: ?//; s/[[:space:]]+$//')

# ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼, ÑÐ²Ð»ÑÐµÑ‚ÑÑ Ð»Ð¸ Ñ‚Ð¸Ð¿ Ð´Ð¾Ð¿ÑƒÑÑ‚Ð¸Ð¼Ñ‹Ð¼
case "$COMMIT_TYPE" in
  patch|minor|major) ;;
  *) COMMIT_TYPE="patch"; echo "ðŸ“Ž Ð¢Ð¸Ð¿ ÐºÐ¾Ð¼Ð¼Ð¸Ñ‚Ð° Ð½Ðµ ÑƒÐºÐ°Ð·Ð°Ð½ Ð¸Ð»Ð¸ Ð½ÐµÐºÐ¾Ñ€Ñ€ÐµÐºÑ‚ÐµÐ½ â€” ÑƒÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½ Ñ‚Ð¸Ð¿ Ð¿Ð¾ ÑƒÐ¼Ð¾Ð»Ñ‡Ð°Ð½Ð¸ÑŽ: $COMMIT_TYPE" ;;
esac

# ÐŸÐ¾Ð»ÑƒÑ‡Ð°ÐµÐ¼ Ð¿Ð¾ÑÐ»ÐµÐ´Ð½Ð¸Ð¹ changeset-Ñ„Ð°Ð¹Ð»
CHANGESET_DIR=$(pwd)/.changeset
CHANGESET_FILE=$(find "$CHANGESET_DIR" -type f -name "*.md" -printf "%T@ %p\n" | sort -n | tail -1 | cut -f2- -d' ')

# ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼, ÑÑƒÑ‰ÐµÑÑ‚Ð²ÑƒÐµÑ‚ Ð»Ð¸ Ñ„Ð°Ð¹Ð»
if [ ! -f "$CHANGESET_FILE" ]; then
  echo "âŒ changeset-Ñ„Ð°Ð¹Ð» Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½ â€” Ð¿ÑƒÑˆ Ð·Ð°Ð±Ð»Ð¾ÐºÐ¸Ñ€Ð¾Ð²Ð°Ð½"
  exit 1
fi

# ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼, Ð¿ÑƒÑÑ‚Ð¾Ð¹ Ð»Ð¸ Ñ„Ð°Ð¹Ð» Ð¸Ð»Ð¸ ÑÐ¾Ð´ÐµÑ€Ð¶Ð¸Ñ‚ Ñ‚Ð¾Ð»ÑŒÐºÐ¾ '---'
FILE_CONTENT=$(cat "$CHANGESET_FILE" | tr -d '[:space:]')
if [ -z "$FILE_CONTENT" ] || [ "$FILE_CONTENT" = "-----" ]; then
  echo "ðŸ“„ changeset-Ñ„Ð°Ð¹Ð» Ð¿ÑƒÑÑ‚Ð¾Ð¹ â€” Ð·Ð°Ð¿Ð¾Ð»Ð½ÑÐµÐ¼ ÐµÐ³Ð¾"
  
  # ÐŸÐµÑ€ÐµÐ·Ð°Ð¿Ð¸ÑÑ‹Ð²Ð°ÐµÐ¼ Ñ„Ð°Ð¹Ð» Ñ Ð½Ð¾Ð²Ñ‹Ð¼Ð¸ Ð´Ð°Ð½Ð½Ñ‹Ð¼Ð¸
  cat > "$CHANGESET_FILE" <<EOL
---
"test-changelog-vite": $COMMIT_TYPE
---
$COMMIT_DESCRIPTION
---
EOL

ALL_CHANGESET_FILES=$(find "$CHANGESET_DIR" -type f -name "*.md" ! -path "$CHANGESET_FILE")
CURRENT_CONTENT=$(cat "$CHANGESET_FILE" | grep -v '^$' | grep -v '^---$' | sed 's/[[:space:]]*$//')

# ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ð½Ð° Ð´ÑƒÐ±Ð»Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ
DUPLICATES_FOUND=false
for OTHER_FILE in $ALL_CHANGESET_FILES; do
  OTHER_CONTENT=$(cat "$OTHER_FILE" | grep -v '^$' | grep -v '^---$' | sed 's/[[:space:]]*$//')

  if [ "$CURRENT_CONTENT" = "$OTHER_CONTENT" ]; then
    echo "âŒ ÐÐ°Ð¹Ð´ÐµÐ½ Ð´ÑƒÐ±Ð»Ð¸Ñ€ÑƒÑŽÑ‰Ð¸Ð¹ Ñ„Ð°Ð¹Ð»: $OTHER_FILE"
    DUPLICATES_FOUND=true
    break
  fi
done

# Ð‘Ð»Ð¾ÐºÐ¸Ñ€ÑƒÐµÐ¼ Ð¿ÑƒÑˆ, ÐµÑÐ»Ð¸ Ð½Ð°Ð¹Ð´ÐµÐ½Ñ‹ Ð´ÑƒÐ±Ð»Ð¸ÐºÐ°Ñ‚Ñ‹
if $DUPLICATES_FOUND; then
  echo "ðŸš« ÐÐ°Ð¹Ð´ÐµÐ½ Ð´ÑƒÐ±Ð»Ð¸Ñ€ÑƒÑŽÑ‰Ð¸Ð¹ changeset-Ñ„Ð°Ð¹Ð» â€” ÑƒÐ´Ð°Ð»ÑÐµÐ¼ Ñ‚ÐµÐºÑƒÑ‰Ð¸Ð¹ Ñ„Ð°Ð¹Ð»"
  
  # Ð£Ð´Ð°Ð»ÑÐµÐ¼ Ñ‚ÐµÐºÑƒÑ‰Ð¸Ð¹ Ð´ÑƒÐ±Ð»Ð¸ÐºÐ°Ñ‚
  rm -f "$CHANGESET_FILE"
  exit 0
fi

echo "âœ… changeset-Ñ„Ð°Ð¹Ð» ÑƒÐ½Ð¸ÐºÐ°Ð»ÐµÐ½ â€” Ð¿ÑƒÑˆ Ñ€Ð°Ð·Ñ€ÐµÑˆÑ‘Ð½"

  git add "$CHANGESET_FILE"
  git commit -m "changelog update" --no-verify
  echo "âœ… changeset-Ñ„Ð°Ð¹Ð» Ð·Ð°Ð¿Ð¾Ð»Ð½ÐµÐ½ Ð¸ Ð·Ð°ÐºÐ¾Ð¼Ð¼Ð¸Ñ‡ÐµÐ½"
else
  echo "ðŸ“„ changeset-Ñ„Ð°Ð¹Ð» ÑƒÐ¶Ðµ Ð·Ð°Ð¿Ð¾Ð»Ð½ÐµÐ½ â€” Ð¿ÑƒÑˆ Ñ€Ð°Ð·Ñ€ÐµÑˆÑ‘Ð½"
fi