#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

# –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —Ñ–ª–∞–≥ --no-verify
if [ "$HUSKY_GIT_PARAMS" = "--no-verify" ]; then
  echo "‚úÖ –•—É–∫ –ø—Ä–æ–ø—É—â–µ–Ω (–∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω --no-verify)"
  exit 0
fi

# –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –∫–æ–º–º–∏—Ç–∞
if [ -f ".git/COMMIT_EDITMSG" ]; then
  COMMIT_MSG=$(cat .git/COMMIT_EDITMSG)
  echo "üìé –¢–µ–∫—É—â–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –∫–æ–º–º–∏—Ç–∞: $COMMIT_MSG"
else
  COMMIT_MSG="feat: unknown commit message"
  echo "‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –Ω–∞–π—Ç–∏ .git/COMMIT_EDITMSG"
fi

# –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â—É—é –≤–µ—Ç–∫—É
CURRENT_BRANCH=$(git rev-parse --abbrev-ref HEAD 2>/dev/null)

# –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è –ª–∏ –≤–µ—Ç–∫–∞ —Å "feature/"
if echo "$CURRENT_BRANCH" | grep -q '^feature/'; then
  echo "üîÑ –í—ã–ø–æ–ª–Ω—è–µ–º –ª–æ–≥–∏–∫—É changeset –¥–ª—è –≤–µ—Ç–∫–∏ $CURRENT_BRANCH"
  
  # –ü–æ–ª—É—á–∞–µ–º –ø—É—Ç—å –∫ –ø–æ—Å–ª–µ–¥–Ω–µ–º—É —Ñ–∞–π–ª—É changeset
  CHANGESET_DIR=$(pwd)/.changeset
  CHANGESET_FILE=$(find "$CHANGESET_DIR" -type f -name "*.md" -printf "%T@ %p\n" | sort -n | tail -1 | cut -f2- -d' ')

  # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –ª–∏ —Ñ–∞–π–ª –∏ –Ω–µ –ø—É—Å—Ç–æ–π –ª–∏ –æ–Ω
  if [ -f "$CHANGESET_FILE" ]; then
    if [ -s "$CHANGESET_FILE" ]; then
      echo "üìÑ changeset-—Ñ–∞–π–ª –Ω–∞–π–¥–µ–Ω –∏ –Ω–µ –ø—É—Å—Ç–æ–π ‚Äî –∏–∑–º–µ–Ω–µ–Ω–∏—è –Ω–µ –≤–Ω–æ—Å—è—Ç—Å—è"
      exit 0
    else
      echo "üìÑ changeset-—Ñ–∞–π–ª –Ω–∞–π–¥–µ–Ω, –Ω–æ –ø—É—Å—Ç–æ–π ‚Äî –ø—Ä–æ–¥–æ–ª–∂–∞–µ–º –æ–±—Ä–∞–±–æ—Ç–∫—É"
    fi
  else
    echo "üìÑ changeset-—Ñ–∞–π–ª –Ω–µ –Ω–∞–π–¥–µ–Ω ‚Äî –æ—à–∏–±–∫–∞"
    exit 0
  fi

  FILE_LINES=$(wc -l < "$CHANGESET_FILE" 2>/dev/null || echo 0)
  while [ "$FILE_LINES" -lt 5 ]; do
    echo "" >> "$CHANGESET_FILE"
    FILE_LINES=$((FILE_LINES + 1))
  done 

  commit_type="${COMMIT_MSG%%:*}"
  commit_description="${COMMIT_MSG#*: }" 

  awk 'NR == 1 { print "---\n" } { print }' "$CHANGESET_FILE" > "$CHANGESET_FILE.tmp" && mv "$CHANGESET_FILE.tmp" "$CHANGESET_FILE"
  awk -v type="$commit_type" 'NR == 2 { print "\"test-changelog-vite\": " type } { print }' "$CHANGESET_FILE" > "$CHANGESET_FILE.tmp" && mv "$CHANGESET_FILE.tmp" "$CHANGESET_FILE"  awk 'NR == 3 { print "---\n" } { print }' "$CHANGESET_FILE" > "$CHANGESET_FILE.tmp" && mv "$CHANGESET_FILE.tmp" "$CHANGESET_FILE"
  awk -v msg="$commit_description" 'NR == 5 { print msg } { print }' "$CHANGESET_FILE" > "$CHANGESET_FILE.tmp" && mv "$CHANGESET_FILE.tmp" "$CHANGESET_FILE"

  git pull

  # –î–æ–±–∞–≤–ª—è–µ–º –∏–∑–º–µ–Ω—ë–Ω–Ω—ã–π changeset-—Ñ–∞–π–ª –≤ –∫–æ–º–º–∏—Ç
  git add .

  git commit -m "changelog update" --no-verify

  # –ü–æ–ª—É—á–∞–µ–º –∏–º—è —Ç–µ–∫—É—â–µ–π –≤–µ—Ç–∫–∏
  CURRENT_BRANCH=$(git rev-parse --abbrev-ref HEAD 2>/dev/null)

  # –í—ã–ø–æ–ª–Ω—è–µ–º git push
  if [ -n "$CURRENT_BRANCH" ]; then
    echo "üì§ –í—ã–ø–æ–ª–Ω—è–µ–º git push origin $CURRENT_BRANCH"
    git push origin "$CURRENT_BRANCH" --no-verify
    echo "Success"
  else
    echo "‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å —Ç–µ–∫—É—â—É—é –≤–µ—Ç–∫—É –¥–ª—è git push"
    exit 1
  fi
else
  echo "‚ÑπÔ∏è –í–µ—Ç–∫–∞ $CURRENT_BRANCH –Ω–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç pattern 'feature/*' ‚Äî changeset –Ω–µ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è"
fi